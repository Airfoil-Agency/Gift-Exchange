<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Family Gift Exchange</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ</text></svg>">
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useEffect } = React;

    // Simple encoding/decoding for response codes
    const encodeResponse = (name, number) => {
      const data = JSON.stringify({ n: name, v: number });
      return btoa(data).replace(/=/g, '').substring(0, 12).toUpperCase();
    };

    const createFullCode = (name, number) => {
      // Create a more robust code that includes all info
      const data = { name, number };
      return btoa(JSON.stringify(data));
    };

    const decodeFullCode = (code) => {
      try {
        const data = JSON.parse(atob(code));
        return data;
      } catch {
        return null;
      }
    };

    // Member Entry View (when someone clicks their personal link)
    function MemberEntryView({ memberName }) {
      const [number, setNumber] = useState('');
      const [submitted, setSubmitted] = useState(false);
      const [responseCode, setResponseCode] = useState('');
      const [copied, setCopied] = useState(false);

      const submitNumber = () => {
        const num = parseInt(number);
        if (num < 1 || num > 40) return;
        
        const code = createFullCode(memberName, num);
        setResponseCode(code);
        setSubmitted(true);
      };

      const copyCode = () => {
        navigator.clipboard.writeText(responseCode);
        setCopied(true);
        setTimeout(() => setCopied(false), 2000);
      };

      if (submitted) {
        return (
          <div className="space-y-6">
            <div className="bg-green-100 border border-green-300 rounded-xl p-6 text-center">
              <span className="text-5xl">âœ…</span>
              <h2 className="text-2xl font-bold text-green-800 mt-4">You're all set, {memberName}!</h2>
              <p className="text-green-600 mt-2">Now send your response code back to the organizer.</p>
            </div>

            <div className="bg-white rounded-xl shadow-lg p-6">
              <h3 className="font-semibold text-gray-700 mb-3 text-center">Your Response Code:</h3>
              <div className="bg-gray-100 rounded-lg p-4 font-mono text-sm break-all text-center border-2 border-dashed border-gray-300">
                {responseCode}
              </div>
              
              <button
                onClick={copyCode}
                className={`w-full mt-4 py-3 rounded-xl font-bold transition-all ${
                  copied 
                    ? 'bg-green-500 text-white' 
                    : 'bg-blue-500 text-white hover:bg-blue-600'
                }`}
              >
                {copied ? 'âœ“ Copied!' : 'ğŸ“‹ Copy Code'}
              </button>

              <div className="mt-4 text-center text-sm text-gray-500">
                Text or email this code to the person who sent you the link!
              </div>
            </div>

            <div className="bg-amber-50 rounded-xl p-4 border border-amber-200">
              <p className="text-sm text-amber-700 text-center">
                ğŸ¤« Your number is hidden in this code - only the organizer's app can read it!
              </p>
            </div>
          </div>
        );
      }

      return (
        <div className="space-y-6">
          <div className="bg-white rounded-xl shadow-lg p-6 text-center">
            <span className="text-5xl">ğŸ‘‹</span>
            <h2 className="text-2xl font-bold text-gray-800 mt-4">
              Welcome, {memberName}!
            </h2>
            <p className="text-gray-600 mt-2">
              Enter your secret number below to join the gift exchange.
            </p>
          </div>

          <div className="bg-white rounded-xl shadow-lg p-6">
            <label className="block text-lg font-semibold text-gray-700 mb-3">
              Pick a number between 1 and 40:
            </label>
            <input
              type="number"
              min="1"
              max="40"
              value={number}
              onChange={(e) => setNumber(e.target.value)}
              placeholder="Enter your number"
              className="w-full px-4 py-3 text-xl text-center border-2 border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-green-400 focus:border-transparent"
            />
            
            <button
              onClick={submitNumber}
              disabled={!number || parseInt(number) < 1 || parseInt(number) > 40}
              className={`w-full mt-4 py-4 rounded-xl font-bold text-lg transition-all ${
                number && parseInt(number) >= 1 && parseInt(number) <= 40
                  ? 'bg-gradient-to-r from-red-500 to-green-500 text-white hover:from-red-600 hover:to-green-600 shadow-lg'
                  : 'bg-gray-300 text-gray-500 cursor-not-allowed'
              }`}
            >
              ğŸ Get My Response Code
            </button>
          </div>

          <div className="bg-amber-50 rounded-xl p-4 border border-amber-200">
            <p className="text-sm text-amber-700 text-center">
              ğŸ¤« Your number is secret! No one else will see what you picked.
            </p>
          </div>
        </div>
      );
    }

    // Main App Component
    function GiftGiverApp() {
      const [step, setStep] = useState('setup'); // setup | share | collect | results
      const [members, setMembers] = useState([]);
      const [newMember, setNewMember] = useState({ name: '', contact: '' });
      const [adminName, setAdminName] = useState('');
      const [adminNumber, setAdminNumber] = useState('');
      const [responseCode, setResponseCode] = useState('');
      const [collectedCodes, setCollectedCodes] = useState([]);
      const [assignments, setAssignments] = useState(null);
      const [copiedLink, setCopiedLink] = useState(null);
      const [memberView, setMemberView] = useState(null);
      const [codeError, setCodeError] = useState('');

      const baseUrl = window.location.origin + window.location.pathname;

      // Check URL for member entry
      useEffect(() => {
        const params = new URLSearchParams(window.location.search);
        const memberName = params.get('member');
        if (memberName) {
          setMemberView(decodeURIComponent(memberName));
        }
      }, []);

      const addMember = () => {
        if (!newMember.name.trim()) return;
        setMembers([...members, { 
          name: newMember.name.trim(), 
          contact: newMember.contact.trim(),
          id: Date.now()
        }]);
        setNewMember({ name: '', contact: '' });
      };

      const removeMember = (id) => {
        setMembers(members.filter(m => m.id !== id));
      };

      const getMemberLink = (member) => {
        return `${baseUrl}?member=${encodeURIComponent(member.name)}`;
      };

      const copyLink = (member) => {
        navigator.clipboard.writeText(getMemberLink(member));
        setCopiedLink(member.id);
        setTimeout(() => setCopiedLink(null), 2000);
      };

      const getSmsLink = (member) => {
        const link = getMemberLink(member);
        const message = `Hey ${member.name}! Click this link to enter your number for our family gift exchange: ${link}`;
        return `sms:${member.contact}?body=${encodeURIComponent(message)}`;
      };

      const getEmailLink = (member) => {
        const link = getMemberLink(member);
        const subject = "Family Gift Exchange - Enter Your Number!";
        const body = `Hey ${member.name}!\n\nClick this link to enter your secret number for our family gift exchange:\n\n${link}\n\nAfter you enter your number, you'll get a response code to send back to me.\n\nHappy Holidays! ğŸ`;
        return `mailto:${member.contact}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
      };

      const proceedToShare = () => {
        if (!adminName.trim() || !adminNumber || members.length < 1) return;
        setStep('share');
      };

      const proceedToCollect = () => {
        // Add admin to collected codes
        const adminCode = createFullCode(adminName, parseInt(adminNumber));
        setCollectedCodes([adminCode]);
        setStep('collect');
      };

      const addResponseCode = () => {
        setCodeError('');
        const decoded = decodeFullCode(responseCode.trim());
        
        if (!decoded) {
          setCodeError('Invalid code. Please check and try again.');
          return;
        }

        // Check if this person already submitted
        const existing = collectedCodes.find(c => {
          const d = decodeFullCode(c);
          return d && d.name === decoded.name;
        });

        if (existing) {
          setCodeError(`${decoded.name} has already submitted a code.`);
          return;
        }

        setCollectedCodes([...collectedCodes, responseCode.trim()]);
        setResponseCode('');
      };

      const calculateAssignments = () => {
        const parsed = collectedCodes.map(code => decodeFullCode(code)).filter(Boolean);

        const results = parsed.map(person => {
          const others = parsed.filter(p => p.name !== person.name);
          
          const closest = others.reduce((prev, curr) =>
            Math.abs(curr.number - person.number) < Math.abs(prev.number - person.number)
              ? curr
              : prev
          );

          const furthest = others.reduce((prev, curr) =>
            Math.abs(curr.number - person.number) > Math.abs(prev.number - person.number)
              ? curr
              : prev
          );

          return {
            person: person.name,
            number: person.number,
            receivesFrom: closest.name,
            givesTo: furthest.name,
            idealMatch: closest.name !== furthest.name,
          };
        });

        setAssignments(results);
        setStep('results');
      };

      const startOver = () => {
        setStep('setup');
        setMembers([]);
        setAdminName('');
        setAdminNumber('');
        setCollectedCodes([]);
        setAssignments(null);
        setResponseCode('');
        window.history.pushState({}, '', window.location.pathname);
      };

      // If viewing as a member
      if (memberView) {
        return (
          <div className="min-h-screen bg-gradient-to-br from-red-50 via-white to-green-50 p-6">
            <div className="max-w-2xl mx-auto">
              <div className="text-center mb-8">
                <div className="text-6xl mb-4">ğŸ</div>
                <h1 className="text-3xl font-bold text-gray-800 mb-2">
                  Family Gift Exchange
                </h1>
              </div>
              <MemberEntryView memberName={memberView} />
              <div className="text-center mt-8 text-gray-400 text-sm">
                Happy Holidays! ğŸ„â„ï¸ğŸ
              </div>
            </div>
          </div>
        );
      }

      return (
        <div className="min-h-screen bg-gradient-to-br from-red-50 via-white to-green-50 p-6">
          <div className="max-w-2xl mx-auto">
            {/* Header */}
            <div className="text-center mb-8">
              <div className="text-6xl mb-4">ğŸ</div>
              <h1 className="text-3xl font-bold text-gray-800 mb-2">
                Family Gift Exchange
              </h1>
              <p className="text-gray-600">
                {step === 'setup' && 'Set up your gift exchange'}
                {step === 'share' && 'Send links to family members'}
                {step === 'collect' && 'Collect response codes'}
                {step === 'results' && 'Gift assignments ready!'}
              </p>
            </div>

            {/* Progress indicator */}
            <div className="flex justify-center mb-8">
              <div className="flex items-center gap-2">
                {['setup', 'share', 'collect', 'results'].map((s, i) => (
                  <React.Fragment key={s}>
                    <div className={`w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold ${
                      step === s ? 'bg-green-500 text-white' : 
                      ['setup', 'share', 'collect', 'results'].indexOf(step) > i ? 'bg-green-200 text-green-700' :
                      'bg-gray-200 text-gray-500'
                    }`}>
                      {i + 1}
                    </div>
                    {i < 3 && <div className={`w-8 h-1 ${
                      ['setup', 'share', 'collect', 'results'].indexOf(step) > i ? 'bg-green-200' : 'bg-gray-200'
                    }`} />}
                  </React.Fragment>
                ))}
              </div>
            </div>

            {/* Step 1: Setup */}
            {step === 'setup' && (
              <div className="space-y-6">
                {/* Admin info */}
                <div className="bg-white rounded-xl shadow-lg p-6">
                  <h2 className="text-xl font-bold text-gray-800 mb-4">ğŸ‘¤ Your Information</h2>
                  <div className="space-y-3">
                    <input
                      type="text"
                      placeholder="Your name"
                      value={adminName}
                      onChange={(e) => setAdminName(e.target.value)}
                      className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-400"
                    />
                    <input
                      type="number"
                      min="1"
                      max="40"
                      placeholder="Your secret number (1-40)"
                      value={adminNumber}
                      onChange={(e) => setAdminNumber(e.target.value)}
                      className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-400"
                    />
                  </div>
                </div>

                {/* Family members */}
                <div className="bg-white rounded-xl shadow-lg p-6">
                  <h2 className="text-xl font-bold text-gray-800 mb-4">ğŸ‘¥ Family Members</h2>
                  
                  <div className="space-y-3 mb-4">
                    <input
                      type="text"
                      placeholder="Name"
                      value={newMember.name}
                      onChange={(e) => setNewMember({...newMember, name: e.target.value})}
                      className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-400"
                    />
                    <input
                      type="text"
                      placeholder="Phone or Email (optional - for easy sending)"
                      value={newMember.contact}
                      onChange={(e) => setNewMember({...newMember, contact: e.target.value})}
                      className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-400"
                    />
                    <button
                      onClick={addMember}
                      disabled={!newMember.name.trim()}
                      className="w-full py-2 bg-green-500 text-white rounded-lg font-medium hover:bg-green-600 disabled:bg-gray-300 disabled:cursor-not-allowed"
                    >
                      + Add Family Member
                    </button>
                  </div>

                  {members.length > 0 && (
                    <div className="space-y-2 border-t pt-4">
                      {members.map((member) => (
                        <div key={member.id} className="flex items-center justify-between bg-gray-50 p-3 rounded-lg">
                          <div>
                            <span className="font-medium">{member.name}</span>
                            {member.contact && (
                              <span className="text-sm text-gray-500 ml-2">({member.contact})</span>
                            )}
                          </div>
                          <button
                            onClick={() => removeMember(member.id)}
                            className="text-red-500 hover:text-red-700 text-sm"
                          >
                            âœ• Remove
                          </button>
                        </div>
                      ))}
                    </div>
                  )}
                </div>

                <button
                  onClick={proceedToShare}
                  disabled={!adminName.trim() || !adminNumber || members.length < 1}
                  className={`w-full py-4 rounded-xl font-bold text-lg transition-all ${
                    adminName.trim() && adminNumber && members.length >= 1
                      ? 'bg-gradient-to-r from-red-500 to-green-500 text-white hover:from-red-600 hover:to-green-600 shadow-lg'
                      : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                  }`}
                >
                  Continue â†’
                </button>
              </div>
            )}

            {/* Step 2: Share Links */}
            {step === 'share' && (
              <div className="space-y-6">
                <div className="bg-white rounded-xl shadow-lg p-6">
                  <h2 className="text-xl font-bold text-gray-800 mb-4">ğŸ“¤ Send Links to Family</h2>
                  <p className="text-gray-600 mb-4">
                    Send each person their personal link. They'll enter their number and get a response code to send back to you.
                  </p>

                  <div className="space-y-4">
                    {members.map((member) => (
                      <div key={member.id} className="bg-gray-50 rounded-lg p-4 border border-gray-200">
                        <div className="font-semibold text-gray-800 mb-3">{member.name}</div>
                        <div className="flex flex-wrap gap-2">
                          <button
                            onClick={() => copyLink(member)}
                            className={`px-3 py-2 rounded-lg text-sm font-medium transition-all ${
                              copiedLink === member.id
                                ? 'bg-green-500 text-white'
                                : 'bg-blue-100 text-blue-700 hover:bg-blue-200'
                            }`}
                          >
                            {copiedLink === member.id ? 'âœ“ Copied!' : 'ğŸ“‹ Copy Link'}
                          </button>
                          
                          {member.contact && member.contact.includes('@') && (
                            <a
                              href={getEmailLink(member)}
                              className="px-3 py-2 rounded-lg text-sm font-medium bg-purple-100 text-purple-700 hover:bg-purple-200"
                            >
                              ğŸ“§ Send Email
                            </a>
                          )}
                          
                          {member.contact && !member.contact.includes('@') && (
                            <a
                              href={getSmsLink(member)}
                              className="px-3 py-2 rounded-lg text-sm font-medium bg-green-100 text-green-700 hover:bg-green-200"
                            >
                              ğŸ’¬ Send Text
                            </a>
                          )}
                        </div>
                      </div>
                    ))}
                  </div>
                </div>

                <div className="bg-amber-50 rounded-xl p-4 border border-amber-200">
                  <h3 className="font-semibold text-amber-800 mb-2">ğŸ“‹ What happens next:</h3>
                  <ol className="text-sm text-amber-700 space-y-1 list-decimal list-inside">
                    <li>Each person clicks their link and enters a number (1-40)</li>
                    <li>They'll get a response code to send back to you</li>
                    <li>You'll collect all the codes in the next step</li>
                  </ol>
                </div>

                <button
                  onClick={proceedToCollect}
                  className="w-full py-4 bg-gradient-to-r from-red-500 to-green-500 text-white rounded-xl font-bold text-lg hover:from-red-600 hover:to-green-600 shadow-lg"
                >
                  I've Sent the Links â†’ Collect Codes
                </button>
              </div>
            )}

            {/* Step 3: Collect Codes */}
            {step === 'collect' && (
              <div className="space-y-6">
                <div className="bg-white rounded-xl shadow-lg p-6">
                  <h2 className="text-xl font-bold text-gray-800 mb-4">ğŸ“¥ Collect Response Codes</h2>
                  <p className="text-gray-600 mb-4">
                    Paste the response codes that family members send back to you.
                  </p>

                  <div className="space-y-3">
                    <textarea
                      placeholder="Paste a response code here..."
                      value={responseCode}
                      onChange={(e) => setResponseCode(e.target.value)}
                      className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-400 font-mono text-sm"
                      rows={2}
                    />
                    {codeError && (
                      <p className="text-red-500 text-sm">{codeError}</p>
                    )}
                    <button
                      onClick={addResponseCode}
                      disabled={!responseCode.trim()}
                      className="w-full py-2 bg-blue-500 text-white rounded-lg font-medium hover:bg-blue-600 disabled:bg-gray-300 disabled:cursor-not-allowed"
                    >
                      + Add Code
                    </button>
                  </div>

                  {/* Collected codes list */}
                  <div className="mt-6 border-t pt-4">
                    <h3 className="font-semibold text-gray-700 mb-3">
                      Codes Received ({collectedCodes.length} of {members.length + 1}):
                    </h3>
                    <div className="space-y-2">
                      {collectedCodes.map((code, i) => {
                        const decoded = decodeFullCode(code);
                        return (
                          <div key={i} className="flex items-center gap-2 bg-green-50 p-3 rounded-lg border border-green-200">
                            <span className="text-green-600">âœ…</span>
                            <span className="font-medium">{decoded?.name || 'Unknown'}</span>
                          </div>
                        );
                      })}
                      {members.filter(m => !collectedCodes.find(c => {
                        const d = decodeFullCode(c);
                        return d && d.name === m.name;
                      })).map((member) => (
                        <div key={member.id} className="flex items-center gap-2 bg-gray-50 p-3 rounded-lg border border-gray-200">
                          <span className="text-gray-400">â³</span>
                          <span className="text-gray-500">{member.name}</span>
                          <span className="text-sm text-gray-400">- waiting...</span>
                        </div>
                      ))}
                    </div>
                  </div>
                </div>

                <button
                  onClick={calculateAssignments}
                  disabled={collectedCodes.length < 2}
                  className={`w-full py-4 rounded-xl font-bold text-lg transition-all ${
                    collectedCodes.length >= 2
                      ? 'bg-gradient-to-r from-red-500 to-green-500 text-white hover:from-red-600 hover:to-green-600 shadow-lg'
                      : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                  }`}
                >
                  {collectedCodes.length >= 2 
                    ? 'ğŸ„ Generate Gift Assignments ğŸ„' 
                    : `Need at least 2 codes (have ${collectedCodes.length})`}
                </button>
              </div>
            )}

            {/* Step 4: Results */}
            {step === 'results' && assignments && (
              <div className="space-y-4">
                <div className="bg-green-100 border border-green-300 rounded-xl p-4 text-center">
                  <span className="text-2xl">ğŸ‰</span>
                  <h2 className="text-xl font-bold text-green-800">Gift Assignments Ready!</h2>
                </div>

                {assignments.map((assignment, index) => (
                  <div key={index} className="bg-white rounded-xl shadow-lg p-5 border-2 border-green-200">
                    <div className="flex items-center justify-between mb-4">
                      <div className="flex items-center gap-3">
                        <span className="text-3xl">ğŸ…</span>
                        <div>
                          <h3 className="text-xl font-bold text-gray-800">{assignment.person}</h3>
                          <span className="text-sm text-gray-500">Number: {assignment.number}</span>
                        </div>
                      </div>
                      {assignment.idealMatch && (
                        <span className="bg-green-100 text-green-700 px-3 py-1 rounded-full text-sm font-medium">
                          âœ“ Ideal
                        </span>
                      )}
                    </div>

                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                      <div className="bg-red-50 rounded-lg p-3 border border-red-200">
                        <div className="text-sm text-red-600 font-medium mb-1">ğŸ Gives to:</div>
                        <div className="text-lg font-bold text-red-700">{assignment.givesTo}</div>
                      </div>
                      <div className="bg-green-50 rounded-lg p-3 border border-green-200">
                        <div className="text-sm text-green-600 font-medium mb-1">ğŸ€ Receives from:</div>
                        <div className="text-lg font-bold text-green-700">{assignment.receivesFrom}</div>
                      </div>
                    </div>
                  </div>
                ))}

                {/* Summary */}
                <div className="bg-white rounded-xl shadow-md p-5 border-t-4 border-amber-400">
                  <h3 className="font-bold text-gray-800 mb-3 flex items-center gap-2">
                    <span className="text-2xl">ğŸ“Š</span> Quick Summary
                  </h3>
                  <div className="space-y-2">
                    {assignments.map((a, i) => (
                      <div key={i} className="flex flex-wrap items-center gap-2 text-gray-700">
                        <span className="font-semibold">{a.person}</span>
                        <span className="text-gray-400">â†’</span>
                        <span className="text-red-600">gives to {a.givesTo}</span>
                        <span className="text-gray-400">|</span>
                        <span className="text-green-600">gets from {a.receivesFrom}</span>
                      </div>
                    ))}
                  </div>
                </div>

                <button
                  onClick={startOver}
                  className="w-full py-3 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-xl font-bold border border-gray-300"
                >
                  ğŸ”„ Start Over
                </button>
              </div>
            )}

            {/* Footer */}
            <div className="text-center mt-8 text-gray-400 text-sm">
              Happy Holidays! ğŸ„â„ï¸ğŸ
            </div>
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<GiftGiverApp />);
  </script>
</body>
</html>
